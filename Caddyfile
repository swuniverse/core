# Star Wars Universe - Caddy Reverse Proxy
# Automatisches HTTPS mit Let's Encrypt

swuniverse.net {
    # Automatisches HTTPS (Let's Encrypt)
    # Caddy macht das vollautomatisch, keine manuelle Konfiguration n√∂tig!

    # Logging
    log {
        output stdout
        format json
    }

    # Security Headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        # Clickjacking Protection
        X-Frame-Options "SAMEORIGIN"
        # MIME-Type Sniffing Prevention
        X-Content-Type-Options "nosniff"
        # XSS Protection
        X-XSS-Protection "1; mode=block"
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Compression (Caddy macht Gzip/Brotli automatisch)
    encode gzip zstd

    # Health Check Endpoint
    handle /health {
        reverse_proxy 127.0.0.1:3000
    }

    # Socket.io WebSocket Support (Enhanced)
    handle /socket.io/* {
        reverse_proxy 127.0.0.1:3000 {
            # WebSocket Headers
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Host {http.request.header.Host}
            header_up X-Real-IP {http.request.header.X-Real-IP}
            header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
            header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}

            # WebSocket-specific settings
            flush_interval -1
            transport http {
                keepalive 30s
                keepalive_idle_conns 10
            }
        }
    }

    # Backend API
    handle /api/* {
        reverse_proxy 127.0.0.1:3000
    }

    # Frontend (React SPA)
    handle {
        reverse_proxy 127.0.0.1:5173
    }
}

mail.swuniverse.net autodiscover.swuniverse.net autoconfig.swuniverse.net {
        log {
                output file /var/log/caddy/mail.swuniverse.net.log {
                        roll_disabled
                        roll_size 512M
                        roll_uncompressed
                        roll_local_time
                        roll_keep 3
                        roll_keep_for 48h
                }
        }

        reverse_proxy 127.0.0.1:8080
}
